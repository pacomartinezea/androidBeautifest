<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AndroidBeautifest - Web</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-black">
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
    const { useState } = React;

    const API_URL = "/analyze-apk";

    // ErrorBoundary
    class ErrorBoundary extends React.Component {
      constructor(props) {
        super(props);
        this.state = { hasError: false, error: null };
      }
      static getDerivedStateFromError(error) {
        return { hasError: true, error };
      }
      componentDidCatch(error, info) {
        console.error("AndroidBeautifest error:", error, info);
      }
      render() {
        if (this.state.hasError) {
          return (
            <div className="min-h-screen bg-black text-white flex items-center justify-center">
              <div className="max-w-lg text-center">
                <h1 className="text-2xl font-bold mb-2">Something went wrong</h1>
                <p className="text-gray-400 text-sm">
                  Check the browser console for details.
                </p>
              </div>
            </div>
          );
        }
        return this.props.children;
      }
    }

    // Simple SVG icons
    const IconBase = ({ className, children }) => (
      <svg
        className={className}
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        strokeWidth="2"
        strokeLinecap="round"
        strokeLinejoin="round"
      >
        {children}
      </svg>
    );

    const Upload = ({ className }) => (
      <IconBase className={className}>
        <path d="M4 17v3h16v-3" />
        <path d="M12 3v12" />
        <polyline points="7 8 12 3 17 8" />
      </IconBase>
    );

    const AlertTriangle = ({ className }) => (
      <IconBase className={className}>
        <path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
        <line x1="12" y1="9" x2="12" y2="13" />
        <line x1="12" y1="17" x2="12.01" y2="17" />
      </IconBase>
    );

    const FileText = ({ className }) => (
      <IconBase className={className}>
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
        <polyline points="14 2 14 8 20 8" />
        <line x1="16" y1="13" x2="8" y2="13" />
        <line x1="16" y1="17" x2="8" y2="17" />
        <line x1="10" y1="9" x2="8" y2="9" />
      </IconBase>
    );

    const Download = ({ className }) => (
      <IconBase className={className}>
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
        <polyline points="7 10 12 15 17 10" />
        <line x1="12" y1="15" x2="12" y2="3" />
      </IconBase>
    );

    const Activity = ({ className }) => (
      <IconBase className={className}>
        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
      </IconBase>
    );

    const Radio = ({ className }) => (
      <IconBase className={className}>
        <circle cx="12" cy="12" r="2" />
        <path d="M16.24 7.76a6 6 0 0 1 0 8.48" />
        <path d="M7.76 7.76a6 6 0 0 0 0 8.48" />
        <path d="M19.07 4.93a10 10 0 0 1 0 14.14" />
        <path d="M4.93 4.93a10 10 0 0 0 0 14.14" />
      </IconBase>
    );

    const Database = ({ className }) => (
      <IconBase className={className}>
        <ellipse cx="12" cy="5" rx="9" ry="3" />
        <path d="M3 5v14c0 1.66 4.03 3 9 3s9-1.34 9-3V5" />
        <path d="M3 12c0 1.66 4.03 3 9 3s9-1.34 9-3" />
      </IconBase>
    );

    const ExternalLink = ({ className }) => (
      <IconBase className={className}>
        <path d="M18 13v6a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
        <polyline points="15 3 21 3 21 9" />
        <line x1="10" y1="14" x2="21" y2="3" />
      </IconBase>
    );

    const AndroidBeautifestWeb = () => {
      const [file, setFile] = useState(null);
      const [analyzing, setAnalyzing] = useState(false);
      const [results, setResults] = useState(null);

      const analyzeAPK = async (apkFile) => {
        setAnalyzing(true);
        setResults(null);

        try {
          const formData = new FormData();
          formData.append("file", apkFile);

          const resp = await fetch(API_URL, {
            method: "POST",
            body: formData,
          });

          if (!resp.ok) {
            throw new Error(`HTTP ${resp.status}`);
          }

          const data = await resp.json();
          setResults(data);
        } catch (err) {
          console.error("Analyze error:", err);
          alert("Error analyzing APK: " + err.message);
        } finally {
          setAnalyzing(false);
        }
      };

      const handleFileUpload = (e) => {
        const uploadedFile = e.target.files[0];
        if (uploadedFile && uploadedFile.name.endsWith(".apk")) {
          setFile(uploadedFile);
          analyzeAPK(uploadedFile);
        } else {
          alert("Please upload a valid APK file");
        }
      };

      const downloadReport = () => {
        if (!results) return;

        let report = `Android Beautifest - Android Manifest Analyzer\n`;
        report += `${"=".repeat(80)}\n\n`;
        report += `Package Name: ${results.packageName}\n`;
        report += `Version Code: ${results.versionCode}\n`;
        report += `Version Name: ${results.versionName}\n`;
        report += `${"-".repeat(80)}\n\n`;

        report += `APPLICATION CONFIGURATION FINDINGS:\n`;
        report += `${"=".repeat(80)}\n`;
        (results.appConfig || []).forEach((issue) => {
          report += `\n[${issue.level}] ${issue.name}\n`;
          report += `Description: ${issue.description}\n`;
          report += `Hint: ${issue.hint}\n`;
        });

        report += `\n\nCOMPONENTS ANALYSIS:\n`;
        report += `${"=".repeat(80)}\n`;
        report += `Total: ${results.totalComponents} | Exported: ${results.exportedComponents} | Unprotected: ${results.unprotectedExported}\n\n`;

        (results.components || []).forEach((comp) => {
          report += `\n${"-".repeat(80)}\n`;
          report += `[${comp.unprotectedExported ? "UNPROTECTED EXPORTED" : comp.exported ? "EXPORTED" : "NOT EXPORTED"}]\n`;
          report += `Type: ${comp.type}\n`;
          report += `Name: ${comp.name}\n`;
          if (comp.permission) report += `Permission: ${comp.permission}\n`;
          if (comp.authority) report += `Authority: ${comp.authority}\n`;
          if (comp.intentActions && comp.intentActions.length > 0) {
            report += `Intent Actions:\n`;
            comp.intentActions.forEach((a) => (report += `  - ${a}\n`));
          }
          if (comp.deepLinks && comp.deepLinks.length > 0) {
            report += `Deep Links:\n`;
            comp.deepLinks.forEach((l) => (report += `  - ${l}\n`));
          }
          report += `Commands:\n`;
          (comp.commands || []).forEach((c) => (report += `  ${c}\n`));
        });

        const blob = new Blob([report], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `report_${results.packageName}.txt`;
        a.click();
      };

      const getLevelColor = (level) => {
        switch (level) {
          case "CRITICAL":
            return "bg-white text-black border-white";
          case "HIGH":
            return "bg-gray-800 text-white border-gray-600";
          case "MEDIUM":
            return "bg-gray-900 text-gray-300 border-gray-700";
          default:
            return "bg-black text-gray-400 border-gray-800";
        }
      };

      const getComponentIcon = (type) => {
        switch (type) {
          case "activity":
            return <Activity className="w-5 h-5" />;
          case "service":
            return <Radio className="w-5 h-5" />;
          case "receiver":
            return <Radio className="w-5 h-5" />;
          case "provider":
            return <Database className="w-5 h-5" />;
          default:
            return <FileText className="w-5 h-5" />;
        }
      };

      const showUpload = !results;
      const showResults = !!results;

      return (
        <div className="min-h-screen bg-black text-white p-6">
          <div className="max-w-7xl mx-auto">
            {/* Header */}
            <div className="text-center mb-8">
              <div className="flex items-center justify-center gap-3 mb-4">
                <div className="text-4xl font-mono text-white">&lt;/&gt;</div>
                <h1 className="text-5xl font-bold text-white">
                  AndroidBeautifest
                </h1>
              </div>
              <p className="text-gray-400 text-lg">
                Android Manifest Analyzer
              </p>
              <p className="text-gray-600 text-sm mt-2">
                By: Lautaro Villarreal Culic'
              </p>
            </div>

            {/* Upload */}
            {showUpload && (
              <div className="bg-zinc-900 border-2 border-dashed border-gray-600 rounded-xl p-12 text-center mb-8 hover:border-gray-400 transition">
                <input
                  type="file"
                  accept=".apk"
                  onChange={handleFileUpload}
                  className="hidden"
                  id="apk-upload"
                  disabled={analyzing}
                />
                <label htmlFor="apk-upload" className="cursor-pointer">
                  <div className="flex flex-col items-center gap-4">
                    <Upload
                      className={`w-16 h-16 ${
                        analyzing ? "animate-bounce" : ""
                      } text-gray-400`}
                    />
                    <div>
                      <p className="text-xl font-semibold mb-2 text-white">
                        {analyzing ? "Analyzing APK..." : "Upload APK File"}
                      </p>
                      <p className="text-gray-500">
                        {analyzing
                          ? "Please wait while we analyze the manifest"
                          : "Click to select or drag and drop"}
                      </p>
                    </div>
                    {file && (
                      <div className="mt-4 text-sm text-gray-400">
                        Selected: {file.name}
                      </div>
                    )}
                  </div>
                </label>
              </div>
            )}

            {/* Results */}
            {showResults && (
              <div className="space-y-6">
                {/* Summary */}
                <div className="bg-zinc-900 rounded-xl p-6 border border-gray-700">
                  <div className="flex flex-col md:flex-row md:items-start md:justify-between gap-4 mb-4">
                    <div>
                      <h2 className="text-2xl font-bold text-white mb-2">
                        Analysis Results
                      </h2>
                      <div className="space-y-1 text-sm">
                        <p>
                          <span className="text-gray-500">Package:</span>{" "}
                          <span className="font-mono text-gray-300">
                            {results.packageName}
                          </span>
                        </p>
                        <p>
                          <span className="text-gray-500">Version:</span>{" "}
                          <span className="text-gray-300">
                            {results.versionName} (Code: {results.versionCode})
                          </span>
                        </p>
                      </div>
                    </div>
                    <div className="flex gap-2">
                      <button
                        onClick={downloadReport}
                        className="flex items-center gap-2 bg-white text-black hover:bg-gray-200 px-4 py-2 rounded-lg transition font-medium"
                      >
                        <Download className="w-4 h-4" />
                        Download Report
                      </button>
                      <button
                        onClick={() => { setResults(null); setFile(null); }}
                        className="bg-zinc-800 hover:bg-zinc-700 text-white px-4 py-2 rounded-lg transition"
                      >
                        New Analysis
                      </button>
                    </div>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                    <div className="bg-black rounded-lg p-4 text-center border border-gray-800">
                      <p className="text-3xl font-bold text-white">
                        {results.totalComponents}
                      </p>
                      <p className="text-sm text-gray-500 mt-1">
                        Total Components
                      </p>
                    </div>
                    <div className="bg-black rounded-lg p-4 text-center border border-gray-800">
                      <p className="text-3xl font-bold text-white">
                        {results.exportedComponents}
                      </p>
                      <p className="text-sm text-gray-500 mt-1">
                        Exported
                      </p>
                    </div>
                    <div className="bg-black rounded-lg p-4 text-center border border-gray-800">
                      <p className="text-3xl font-bold text-white">
                        {results.unprotectedExported}
                      </p>
                      <p className="text-sm text-gray-500 mt-1">
                        Unprotected
                      </p>
                    </div>
                  </div>
                </div>

                {/* App config */}
                <div className="bg-zinc-900 rounded-xl p-6 border border-gray-700">
                  <h3 className="text-xl font-bold mb-4 flex items-center gap-2 text-white">
                    <AlertTriangle className="w-6 h-6" />
                    Application Configuration Findings
                  </h3>
                  <div className="space-y-4">
                    {(results.appConfig || []).map((issue, idx) => (
                      <div
                        key={idx}
                        className={`border rounded-lg p-4 ${getLevelColor(
                          issue.level
                        )}`}
                      >
                        <div className="flex items-start justify-between mb-2">
                          <h4 className="font-bold text-lg">
                            [{issue.level}] {issue.name}
                          </h4>
                        </div>
                        <p className="mb-2">
                          <span className="font-semibold">Description:</span>{" "}
                          {issue.description}
                        </p>
                        <p className="text-sm">
                          <span className="font-semibold">Hint:</span>{" "}
                          {issue.hint}
                        </p>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Components */}
                <div className="bg-zinc-900 rounded-xl p-6 border border-gray-700">
                  <h3 className="text-xl font-bold mb-4 flex items-center gap-2 text-white">
                    <FileText className="w-6 h-6" />
                    Components Analysis
                  </h3>
                  <div className="space-y-4">
                    {(results.components || []).map((comp, idx) => (
                      <div
                        key={idx}
                        className={`border rounded-lg p-5 ${
                          comp.unprotectedExported
                            ? "bg-white text-black border-white"
                            : comp.exported
                            ? "bg-gray-800 border-gray-600"
                            : "bg-black border-gray-800"
                        }`}
                      >
                        <div className="flex items-start justify-between mb-3">
                          <div className="flex items-center gap-3">
                            {getComponentIcon(comp.type)}
                            <div>
                              <div className="flex items-center gap-2 mb-1">
                                <span
                                  className={`px-2 py-1 rounded text-xs font-bold ${
                                    comp.unprotectedExported
                                      ? "bg-black text-white"
                                      : comp.exported
                                      ? "bg-gray-700 text-white"
                                      : "bg-gray-800 text-gray-300"
                                  }`}
                                >
                                  {comp.unprotectedExported
                                    ? "UNPROTECTED EXPORTED"
                                    : comp.exported
                                    ? "EXPORTED"
                                    : "NOT EXPORTED"}
                                </span>
                                <span
                                  className={`text-xs px-2 py-1 rounded uppercase ${
                                    comp.unprotectedExported
                                      ? "bg-black text-white"
                                      : "bg-gray-700 text-gray-300"
                                  }`}
                                >
                                  {comp.type}
                                </span>
                              </div>
                              <p
                                className={`font-mono text-sm ${
                                  comp.unprotectedExported
                                    ? "text-black"
                                    : "text-gray-300"
                                }`}
                              >
                                {comp.name}
                              </p>
                            </div>
                          </div>
                        </div>

                        {comp.permission && (
                          <div className="mb-3 text-sm">
                            <span
                              className={
                                comp.unprotectedExported
                                  ? "text-gray-700"
                                  : "text-gray-400"
                              }
                            >
                              Permission:
                            </span>{" "}
                            <span
                              className={`font-mono ${
                                comp.unprotectedExported
                                  ? "text-black"
                                  : "text-gray-200"
                              }`}
                            >
                              {comp.permission}
                            </span>
                          </div>
                        )}

                        {comp.authority && (
                          <div className="mb-3 text-sm">
                            <span
                              className={
                                comp.unprotectedExported
                                  ? "text-gray-700"
                                  : "text-gray-400"
                              }
                            >
                              Authority:
                            </span>{" "}
                            <span
                              className={`font-mono ${
                                comp.unprotectedExported
                                  ? "text-black"
                                  : "text-gray-200"
                              }`}
                            >
                              {comp.authority}
                            </span>
                            {comp.grantUriPermissions && (
                              <span
                                className={`ml-2 ${
                                  comp.unprotectedExported
                                    ? "text-gray-700"
                                    : "text-gray-400"
                                }`}
                              >
                                (grantUriPermissions=true)
                              </span>
                            )}
                          </div>
                        )}

                        {comp.intentActions &&
                          comp.intentActions.length > 0 && (
                            <div className="mb-3">
                              <p
                                className={`text-sm mb-1 ${
                                  comp.unprotectedExported
                                    ? "text-gray-700"
                                    : "text-gray-400"
                                }`}
                              >
                                Intent Actions:
                              </p>
                              <div className="flex flex-wrap gap-2">
                                {comp.intentActions.map((action, i) => (
                                  <span
                                    key={i}
                                    className={`text-xs px-2 py-1 rounded font-mono ${
                                      comp.unprotectedExported
                                        ? "bg-gray-200 text-black"
                                        : "bg-gray-700 text-gray-200"
                                    }`}
                                  >
                                    {action}
                                  </span>
                                ))}
                              </div>
                            </div>
                          )}

                        {comp.deepLinks && comp.deepLinks.length > 0 && (
                          <div className="mb-3">
                            <p
                              className={`text-sm mb-1 ${
                                comp.unprotectedExported
                                  ? "text-gray-700"
                                  : "text-gray-400"
                              }`}
                            >
                              Deep Links:
                            </p>
                            <div className="space-y-1">
                              {comp.deepLinks.map((link, i) => (
                                <div
                                  key={i}
                                  className={`text-xs px-2 py-1 rounded font-mono flex items-center gap-2 ${
                                    comp.unprotectedExported
                                      ? "bg-gray-200 text-black"
                                      : "bg-gray-700 text-gray-200"
                                  }`}
                                >
                                  <ExternalLink className="w-3 h-3" />
                                  {link}
                                </div>
                              ))}
                            </div>
                          </div>
                        )}

                        <div>
                          <p
                            className={`text-sm mb-2 font-semibold ${
                              comp.unprotectedExported
                                ? "text-gray-700"
                                : "text-gray-400"
                            }`}
                          >
                            Attack Commands:
                          </p>
                          <div
                            className={`rounded p-3 space-y-1 overflow-x-auto ${
                              comp.unprotectedExported
                                ? "bg-gray-200"
                                : "bg-black"
                            }`}
                          >
                            {(comp.commands || []).map((cmd, i) => (
                              <div
                                key={i}
                                className={`text-xs font-mono ${
                                  comp.unprotectedExported
                                    ? "text-black"
                                    : "text-gray-300"
                                }`}
                              >
                                {cmd}
                              </div>
                            ))}
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(
      <ErrorBoundary>
        <AndroidBeautifestWeb />
      </ErrorBoundary>
    );
  </script>
</body>
</html>
